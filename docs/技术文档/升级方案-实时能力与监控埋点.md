## 升级方案：实时能力（WebSocket）与监控/埋点（B 端 / C 端 / 后端 Express + Mongoose）

### 1. 背景与目标

- 统一实现实时能力与端到端观测：在 B 端（管理后台）与 C 端（用户前台）埋点采集 PV/UV、路由停留、关键交互、接口性能、错误日志、Web Vitals，并支持 WebSocket 实时数据推送（订单、预约、消息等）。
- 后端（Express + Mongoose）建设可观测与配置能力：埋点采集接口、数据模型、清洗聚合、告警、远程配置/特性开关（Feature Flags）与 WebSocket 服务端，实现消息发布/订阅、鉴权、限流、心跳与重连。
- 以最小侵入方式接入；可灰度、可配置、可审计，重视隐私合规（匿名化/脱敏、采样、DNT/Consent）。

> 注：此前文案中的“实施能力”为笔误，实际为“实时能力（WebSocket）”。

---

### 2. 总体架构（简要）

```mermaid
graph LR
  subgraph Frontends
    B[B 端 Admin SPA]
    C[C 端 Web/App]
  end

  subgraph SDKs
    T[Telemetry SDK\n(埋点/性能/错误 + 批量上报)]
    W[WebSocket Client\n(心跳/重连/订阅/鉴权)]
  end

  subgraph Backend(Express)
    I[/POST /api/telemetry/batch\nGET /api/telemetry/config/]
    S((WebSocket Server))
    F[/GET /api/flags\nGET /api/config/remote/]
  end

  M[(MongoDB\nMongoose Models)]

  B --> T
  C --> T
  B --> W
  C --> W

  T --> I
  I --> M
  S --> M
  F --> M
  W --> S
```

---

### 3. B 端（管理后台）方案

- 核心指标与事件
  - 路由：PV/路由进入/停留时长/跳出
  - 交互：按钮/菜单/批量操作/导出等关键事件（含业务上下文，如资源 ID）
  - 接口：成功率、状态码、耗时、重试、超时
  - 性能：Web Vitals（LCP/FID/CLS/INP/TTFB）、资源加载耗时
  - 错误：JS 运行时错误、Promise 未捕获错误、接口失败

- 前端 Telemetry SDK（轻量封装）
  - 建议目录：`src/monitoring/telemetry.ts`
  - 能力：初始化（app、release、user、采样率、endpoint）、`trackPageView/trackEvent/trackError/trackPerf/setUser/flush`、离线缓存、批量上报、采样控制。
  - 批量上报触发：数量阈值/定时（如 10s）/页面隐藏（visibilitychange）/恢复在线（online）。
  - 队列与重试：沿用当前仓库已有 `src/utils/TaskQueue.ts` 的并发/重试理念；并参考提供的 `TaskQueue.js` 设计（见“9. 任务队列对齐”），新增一个专用队列工厂 `createTelemetryTaskQueue`（低并发、间隔 200ms、指数回退、超时 8~10s）。

- 路由与性能埋点实践
  - 在根路由组件使用 `useLocation()` 监听变更：进入时 `trackPageView`，离开时上报停留时长。
  - 接入 `web-vitals`，采集 LCP/FID/CLS/INP/TTFB，通过 `trackPerf` 上报。

- 接口埋点实践
  - 在 `src/utils/request.ts` 拦截器里记录：开始时间、结束时间、状态码、失败原因，统一 `trackEvent('api_call', {...})`。

- 实时能力（WebSocket）
  - 建议封装 `useWebSocket` Hook：
    - 鉴权：在连接 URL 上带短期 JWT 或通过 `auth` 事件完成鉴权
    - 心跳：客户端 `ping`/服务端 `pong` 或反之；超时重连
    - 重连：指数退避（基础 1s、最大 30s，抖动）
    - 订阅：根据角色/模块订阅房间，如 `admin:orders`、`admin:reservations`
    - 去抖合并：高频事件（如状态变更）本地做 200~500ms 合并再渲染

- 配置/灰度
  - `GET /api/telemetry/config`：返回采样率、禁用字段、允许上报事件白名单
  - `GET /api/flags`：返回特性开关与灰度规则；前端按开关控制埋点与实时订阅范围

---

### 4. C 端（用户前台）方案

- 基本同 B 端，但更重视隐私与端能力差异：
  - 更严格的采样（默认 1%~5%）、尊重 DNT/Consent、避免上报 PII（邮箱/手机号需哈希或脱敏）
  - 实时能力用于：订单状态、预约状态、消息/通知、聊天室等
  - 移动端注意弱网：离线缓存 + 延迟上报，重连策略更保守

---

### 5. 后端（Express + Mongoose）实现

#### 5.1 埋点采集接口
- 路由
  - `POST /api/telemetry/batch`：批量接收事件
  - `GET /api/telemetry/config`：返回采样率、字段白/黑名单、最大批次大小、最大发送间隔等
- 数据结构（Mongoose Schema 示例字段）
  - `TelemetryEvent`：`app`, `env`, `release`, `userId`, `sessionId`, `type`(page/event/error/perf/api), `name`, `props`, `ts`
  - TTL/分片
    - 对大体量表（如 `TelemetryEvent`）设 `ttl` 索引（如 30~90 天）
    - 关键聚合结果长期保存到专门 `Agg` 集合（日报/小时）
- 保护
  - 身份：校验上报来源（JWT / HMAC 签名），限制匿名上报域名
  - 限流：IP + User 级速率限制（如 60 req/min）
  - 校验：最大负载、字段白名单、字段脱敏（邮箱/手机号哈希，IP 仅保留 /24 网段）

#### 5.2 WebSocket 服务（推荐 socket.io，或 `ws`）
- 鉴权
  - 连接 Query/JWT 鉴权 -> 解析 userId/role -> 绑定房间：如 `user:{id}`、`role:admin`
- 心跳与重连
  - 服务器端定期 emit `ping` 或使用 socket.io 内建心跳；超时断开
- 推送模型
  - 业务动作（订单更新、预约审核、通知发布）完成后，通过事件总线向 Socket 层 emit（避免在 Mongoose ChangeStream 上强依赖副本集）
  - 房间广播：
    - 管理员：`io.to('role:admin').emit('reservation:update', payload)`
    - 指定用户：`io.to('user:123').emit('order:update', payload)`
- 限流与反压
  - 对单连接消息队列长度上限与节流；服务端单房间广播做批合并（如 100ms 合并）

#### 5.3 聚合与告警
- 定时聚合（node-cron）：
  - T+1/小时聚合：PV/UV、接口成功率 P95/P99、错误 TopK、性能指标分位数
  - 结果落地 `AggTelemetryHourly`/`AggTelemetryDaily`
- 告警（Webhook 到飞书/钉钉/Slack）
  - 规则示例：错误率 > 2%，接口 P95 > 1.5s，WS 丢包/断开率 > 5%
  - 去抖：同一规则 N 分钟内只告警一次；支持手动确认与静默窗口

#### 5.4 远程配置/特性开关（Flags）
- 路由
  - `GET /api/flags`：按用户/角色/环境返回开关
  - `GET /api/config/remote`：返回远程配置（包含 telemetry 采样率与 WS 配置）
- 存储
  - `FeatureFlag`：`key`, `enabled`, `rules`（如角色/百分比灰度）、`startAt`/`endAt`

#### 5.5 合规与安全
- 隐私最小化：默认关闭 PII；如需使用，必须显式配置并脱敏
- 采样与匿名化：默认 1% 采样（C 端）；IP/UA 并行用以大盘分析，避免存储原始 IP
- 跨站与注入：严格 CORS 白名单、JSON schema 校验、截断超长字段

---

### 6. 前后端对接：事件与载荷规范（示例）

- `page_view`
  - 示例：`{ type: 'page', name: '/admin/orders', ts, referrer, stayMs, user: { id, role } }`
- `event`
  - 示例：`{ type: 'event', name: 'product.off_sale', props: { productId }, ts }`
- `api_call`
  - 示例：`{ type: 'api', name: 'GET /api/mall/orders/admin', status: 200, durationMs: 123, ts }`
- `perf`
  - 示例：`{ type: 'perf', name: 'web-vitals', props: { LCP, FID, CLS, INP, TTFB }, ts }`
- `error`
  - 示例：`{ type: 'error', name: 'UnhandledRejection', message, stack, fatal: false, ts }`

---

### 7. 迭代与验收

- 第 1 期（1 周）
  - 后端：`/api/telemetry/batch`、`/api/telemetry/config`、Mongoose 模型 + TTL、基础聚合脚本
  - B 端：SDK 初始化、路由与接口埋点，批量上报（TaskQueue），看板初版（按天统计）
  - 验收：无卡死/内存泄漏；上报成功率 > 99%；看板数据 T+1 一致
- 第 2 期（1~2 周）
  - WebSocket：鉴权、心跳、重连、订阅；B 端订单/预约实时刷新
  - 告警：错误率与接口延迟规则，Webhook 联动
  - 验收：断网/重连稳定；推送延迟 P95 < 1s；误告警率低
- 第 3 期（按需）
  - C 端 SDK 接入、A/B 实验、远程配置面板、更多可视化大盘

---

### 8. 与现有代码对齐与落地点位

- 前端
  - 请求封装：`src/utils/request.ts` 请求/响应拦截点插桩，统一 `api_call`
  - 队列：在 `src/utils/TaskQueue.ts` 基础上，新建 `createTelemetryTaskQueue`（与商品规格队列类似配置，更偏可靠/低并发）
  - 入口：在 `src/main.tsx` 初始化 Telemetry（读取远程配置）、注册错误捕获（`window.onerror` / `unhandledrejection`）
  - 路由：`src/router/index.tsx` 或根布局中监听 `useLocation()`
  - 实时能力：新增 `hooks/useWebSocket.ts`（心跳/重连/订阅），在订单、预约等页面按需使用

- 后端（新加）
  - 路由：`/api/telemetry/batch`、`/api/telemetry/config`、`/api/flags`
  - 模型：`TelemetryEvent`, `AggTelemetryHourly`, `FeatureFlag`
  - WebSocket：`ws` 或 `socket.io` 服务，业务事件触发时 emit 到相应房间

---

### 9. 任务队列实现对齐说明（参考 TaskQueue.js）

你提供的 `TaskQueue.js` 具备更完善的说明与更丰富的能力（优先级、指数退避、暂停/恢复/停止、进度/结果汇总、任务级配置覆盖等）。建议：

- 前端：
  - 保留现有 `src/utils/TaskQueue.ts` 用于业务批量（如商品规格），并新增一个“遥测专用队列”工厂：`createTelemetryTaskQueue({ maxConcurrent: 2, requestInterval: 200, maxRetries: 3, retryDelay: 1500, timeout: 10000 })`，在埋点 SDK 内部使用，避免对页面交互造成压力。
  - 进度订阅用于调试模式；线上采样 + 静默运行。

- 后端（可选）：
  - 在聚合脚本或外部采集器中，也可重用同理念（Node 侧队列 + 指数退避）处理第三方回传或消息推送任务。

如需，我可以将 `TaskQueue.js` 迁移为 TypeScript 并与现有 `TaskQueue.ts` 合并为单一高能力实现（保留现用 API），以减少心智成本。

---

### 10. 合规与安全清单（上线前核对）

- **采样与开关**：默认 C 端 1% 采样，B 端 5%，可远程下发；可一键关闭全部埋点
- **PII**：邮箱/手机号做哈希；IP 仅保留网段；支持 DNT/Consent
- **限流**：上报接口限流；WS 连接数限制与广播节流
- **数据留存**：事件 TTL（30~90 天）；聚合表长期保存
- **容灾**：上报端离线缓存；服务端 5xx 退避重试；WS 热更新与平滑重启


